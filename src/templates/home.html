<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>home</title>
    <style>
        #pay-section {
            float: left;
            width: 15%;
        }

        #sheet_viewer {
            float: right;
            width: 85%;
            height: 500px;
        }

        /*#hover_view {*/
        /*    background-color: black;*/
        /*    height: 300px;*/
        /*}*/

        #major-container, #summary-section{
            display: flex;
            flex-wrap: wrap;
        }

        #major-content {
            width: 50%;
        }

        #major-content-recommended-container {
            width: 50%;
        }

        .debt-trans-row {
            display: none;
        }

        .summary-block {
            width: 30%;
        }

        #summary-section h2 {
            width: 100%;
        }

    </style>
</head>
<body>

<div id="major-container">
    <div id="major-content">

    </div>

    <div id="major-content-recommended-container">
        <div id="major-content-recommended">


        </div>
        <button id="debt-trans-submit" onclick="AbortController">就这么办吧！</button>
    </div>

</div>


<hr>

<div id="summary-section">
    <h2>Summary</h2>
    <div class="summary-block">
        <h3>Current month：</h3>
        <span id="summary-current-month-content">


        </span>
    </div>

    <div class="summary-block">
        <h3>Last month：</h3>
        <span id="summary-last-month-content">


        </span>
    </div>

    <div class="summary-block">
        <h3>Total summary：</h3>
        <span id="summary-total-content">


        </span>
    </div>
</div>



<hr>


<div id="pay-section">
    <h2>Add transaction</h2>
    <form id="pay-form">
        <label for="from">From:</label><br>
        <select id="from" name="from">


        </select><br>
        <label for="to">To:</label><br>
        <select id="to" name="to">

        </select><br>
        <label for="amount">Amount:</label><br>
        <input type="text" id="amount" name="amount" value=0><br>
        <input type="submit" value="add transaction">
    </form>
</div>


<div id="sheet_viewer">
    <p>If no permission, request for the permission, then refresh</p>
    <a target="_blank" href="https://docs.google.com/spreadsheets/d/1gkVUAVPc7NXV1FBe1b9tp-3x8KcvUEr_BLV5n-wdBco/edit#gid=0">https://docs.google.com/spreadsheets/d/1gkVUAVPc7NXV1FBe1b9tp-3x8KcvUEr_BLV5n-wdBco/edit#gid=0</a>
    <iframe
            src="https://docs.google.com/spreadsheets/d/1gkVUAVPc7NXV1FBe1b9tp-3x8KcvUEr_BLV5n-wdBco/edit?usp=sharing?&rm=minimal&single=true&widget=false;"
            height="100%"
            width="100%"
    ></iframe>

</div>


<div id="hover_view">


</div>





</body>


<script>
    function objectifyForm(formArray) {
        //serialize data function
        let returnArray = {};
        for (var i = 0; i < formArray.length; i++){
            returnArray[formArray[i]['name']] = formArray[i]['value'];
        }
        return returnArray;
    }

    function clearDebt(btn) {
        let from = btn.getAttribute("data-from")
        let to = btn.getAttribute("data-to")
        let amount = btn.getAttribute("data-amount")

        let xhr = new XMLHttpRequest();
        xhr.open('POST','https://4j5pmxdan9.execute-api.us-east-1.amazonaws.com/test-2/pay')
        xhr.setRequestHeader("Content-Type", "application/json");

        //send the form data
        xhr.send(JSON.stringify({"from": from, "to": to, "amount": amount}));
        xhr.onreadystatechange = function() {
            if(xhr.readyState === 4 && xhr.status === 200) {
                console.log(xhr.responseText);
                self.retrieveNewUser(name);
                alert("Finished, page will be reloaded")
                window.location.reload();
            }
        }
    }

    var form = document.getElementById('pay-form');
    form.onsubmit = function(event){
        let xhr = new XMLHttpRequest();
        let formData = new FormData(form);
        //open the request
        xhr.open('POST','https://4j5pmxdan9.execute-api.us-east-1.amazonaws.com/test-2/pay')
        xhr.setRequestHeader("Content-Type", "application/json");

        //send the form data
        xhr.send(JSON.stringify(Object.fromEntries(formData)));

        xhr.onreadystatechange = function() {
            if(xhr.readyState === 4 && xhr.status === 200) {
                console.log(xhr.responseText);
                self.retrieveNewUser(name);
                alert("Finished, page will be reloaded")
                window.location.reload();
            }

        }
        //Fail the onsubmit to avoid page refresh.
        return false;
    }

    let debt_trans_btn = document.getElementById("debt-trans-submit")
    debt_trans_btn.onclick = function (event) {
        let debt_trans_forms = document.getElementsByClassName("debt-trans-form")

        let result_json_list = []
        for (var i = 0; i < debt_trans_forms.length; i++){
            result_json_list.push(objectifyForm(debt_trans_forms[i]))
        }
        let xhr = new XMLHttpRequest();

        let json_data = JSON.stringify(result_json_list)

        if (json_data !== "[]"){
            xhr.open('POST','https://4j5pmxdan9.execute-api.us-east-1.amazonaws.com/test-2/debt-trans')
            xhr.setRequestHeader("Content-Type", "application/json");

            //send the form data

            xhr.send(json_data);

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    alert("中嘞哥ᕕ( ᐛ )ᕗ, page will be reloaded")
                    window.location.reload();
                }
            }
        } else {
            alert("已经可以了，已经是最优解了，可以不用再卷了( ʘ̅ι_ʘ̅ )")
        }

    }

    function httpGetAsync(theUrl, callback){
        let xmlHttp = new XMLHttpRequest();

        xmlHttp.onreadystatechange = function() {
            if (xmlHttp.readyState === 4 && xmlHttp.status === 200)
                callback(xmlHttp.responseText);
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous
        xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xmlHttp.send(null);
    }

    function load_major_content(response){
        let major_content = document.getElementById("major-content");
        major_content.innerHTML = "<h2>现在呢就是这么个状况：</h2>";
        let info = JSON.parse(response);
        info = JSON.parse(info["body"]);

        let info_major_content = info["major_content"]
        let content = "";
        for(let key in info_major_content){
            content += "<p>";
            content += `${key} : {`
            for(let sub_key in info_major_content[key]){
                content += `"${sub_key}": ${info_major_content[key][sub_key]} <button class="clear_debt_btn" data-from="${key}" data-to="${sub_key}" data-amount="${info_major_content[key][sub_key]}" onclick="clearDebt(this)">还钱</button>`;

            }
            content += "}</p>";
        }
        major_content.innerHTML += content;
        major_content.innerHTML += "<button onClick='window.location.reload();'>Refresh Page</button>";

        let major_content_recommended = document.getElementById("major-content-recommended");
        info_recommended_content = info["recommended_result"];
        content = "";

        for(let key in info_recommended_content){
            content += "<p>";
            content += `${key} : {`
            let sum_value = 0
            for(let sub_key in info_recommended_content[key]){
                content += `"${sub_key}": ${info_recommended_content[key][sub_key]}`;
                sum_value += info_recommended_content[key][sub_key];
            }
            sum_value = Math.round(sum_value * 100) / 100
            content += `} sum: ${sum_value} </p>`;
        }
        major_content_recommended.innerHTML += content;
        major_content_recommended.innerHTML += "<hr>";

        info_debt_transfer_procedure = info["debt_transfer_procedure"];
        content = "";

         for(let procedure of info_debt_transfer_procedure) {

             let from_user = procedure["from"];
             let about_user = procedure["about_who"];
             let amount = procedure["amount"];
             let to_user = procedure["to"];

             content += `
                <form class="debt-trans-form">
                    <p>[${from_user}]将[${about_user}][${amount}]的债务转移给[${to_user}]</p>
                    <input type="text" class="debt-trans-row" name="from" value="${from_user}">
                    <input type="text" class="debt-trans-row" name="to" value="${to_user}">
                    <input type="text" class="debt-trans-row" name="about_who" value="${about_user}">
                    <input type="text" class="debt-trans-row" name="amount" value=${amount}>
                </form>
            `
         }
         major_content_recommended.innerHTML += content;



        let summary_current_month_content = document.getElementById("summary-current-month-content");
        let info_curr_month_summary = info["curr_month_summary"];
        content = "";
        for(let key in info_curr_month_summary) {
            value = info_curr_month_summary[key];
            content += `
                <p>
                    ${key}: ${value}
                </p>
            `
        }
        summary_current_month_content.innerHTML = content


        let summary_last_month_content = document.getElementById("summary-last-month-content");
        info_curr_month_summary = info["last_month_summary"];
        content = "";
        for(let key in info_curr_month_summary) {
            value = info_curr_month_summary[key];
            content += `
                <p>
                    ${key}: ${value}
                </p>
            `
        }
        summary_last_month_content.innerHTML = content



        let summary_total_content = document.getElementById("summary-total-content");
        info_total_summary = info["total_summary"];
        content = "";
        for(let key in info_total_summary) {
            value = info_total_summary[key];
            content += `
                <p>
                    ${key}: ${value}
                </p>
            `
        }
        summary_total_content.innerHTML = content

        let from_form = document.getElementById("from");
        content = "";
        from_users = info["from_users"];
        for(let user of from_users) {
            content += `<option value="${user}">${user}</option>`
        }
        from_form.innerHTML = content


        let to_form = document.getElementById("to");
        content = "";
        to_users = info["to_users"];
        for(let user of to_users) {
            content += `<option value="${user}">${user}</option>`
        }
        to_form.innerHTML = content
    }

    httpGetAsync("https://4j5pmxdan9.execute-api.us-east-1.amazonaws.com/test-2/get-major-content", load_major_content);


</script>
</html>